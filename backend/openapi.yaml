openapi: 3.0.3
info:
  title: Social Worker Platform API
  description: |
    ソーシャルワーカープラットフォームのREST API仕様書

    病院と介護施設をつなぐ患者受け入れマッチングプラットフォーム
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:8080
    description: ローカル開発環境
  - url: https://your-backend.onrender.com
    description: 本番環境

tags:
  - name: 認証
    description: ログイン・認証関連
  - name: 病院
    description: 病院管理（管理者のみ）
  - name: 施設
    description: 施設管理
  - name: リクエスト
    description: 受け入れリクエスト管理
  - name: メッセージルーム
    description: メッセージルーム・チャット機能
  - name: 書類
    description: 書類管理

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT認証トークン

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        email:
          type: string
          format: email
          example: hospital1@example.com
        role:
          type: string
          enum: [admin, hospital, facility]
          example: hospital
        created_at:
          type: string
          format: date-time

    Hospital:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 2
        name:
          type: string
          example: 東京総合病院
        address:
          type: string
          example: 東京都新宿区西新宿1-1-1
        phone:
          type: string
          example: 03-1234-5678
        created_at:
          type: string
          format: date-time

    Facility:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 3
        name:
          type: string
          example: さくら介護施設
        address:
          type: string
          example: 東京都渋谷区1-1-1
        phone:
          type: string
          example: 03-5678-1234
        bed_capacity:
          type: integer
          example: 50
        acceptance_conditions:
          type: string
          example: 24時間看護体制。医療依存度の高い方も受け入れ可能。
        created_at:
          type: string
          format: date-time

    PlacementRequest:
      type: object
      properties:
        id:
          type: integer
          example: 1
        hospital_id:
          type: integer
          example: 1
        facility_id:
          type: integer
          example: 1
        patient_age:
          type: integer
          example: 80
        patient_gender:
          type: string
          enum: [男性, 女性, その他]
          example: 男性
        medical_condition:
          type: string
          example: 肝臓がん手術後、リハビリ必要。ADL一部介助。
        status:
          type: string
          enum: [pending, accepted, rejected]
          example: pending
        room_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time

    MessageRoom:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        request_id:
          type: integer
          example: 1
        hospital_id:
          type: integer
          example: 1
        facility_id:
          type: integer
          example: 1
        status:
          type: string
          enum: [negotiating, accepted, completed, rejected]
          example: negotiating
        hospital_completed:
          type: boolean
          example: false
        facility_completed:
          type: boolean
          example: false
        hospital_name:
          type: string
          example: 東京総合病院
        facility_name:
          type: string
          example: さくら介護施設
        patient_age:
          type: integer
          example: 80
        patient_gender:
          type: string
          example: 男性
        medical_condition:
          type: string
          example: 肝臓がん手術後
        created_at:
          type: string
          format: date-time

    Message:
      type: object
      properties:
        id:
          type: integer
          example: 1
        room_id:
          type: string
          format: uuid
        sender_id:
          type: integer
          example: 2
        message_text:
          type: string
          example: よろしくお願いします
        created_at:
          type: string
          format: date-time

    RoomFile:
      type: object
      properties:
        id:
          type: integer
          example: 1
        room_id:
          type: string
          format: uuid
        sender_id:
          type: integer
          example: 2
        file_name:
          type: string
          example: document.pdf
        file_path:
          type: string
          example: /uploads/rooms/123456_document.pdf
        file_type:
          type: string
          example: .pdf
        file_size:
          type: integer
          example: 1024000
        created_at:
          type: string
          format: date-time

    Document:
      type: object
      properties:
        id:
          type: integer
          example: 1
        sender_id:
          type: integer
          example: 2
        recipient_id:
          type: integer
          example: 3
        title:
          type: string
          example: 診断書
        file_path:
          type: string
          example: /uploads/123456_document.pdf
        document_type:
          type: string
          example: 診断書
        folder:
          type: string
          example: 医療記録
        created_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
          example: エラーメッセージ

paths:
  /health:
    get:
      summary: ヘルスチェック
      tags: [認証]
      responses:
        "200":
          description: サーバー稼働中
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/auth/login:
    post:
      summary: ログイン
      tags: [認証]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: hospital1@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        "200":
          description: ログイン成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    $ref: "#/components/schemas/User"
        "401":
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/logout:
    post:
      summary: ログアウト
      tags: [認証]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: ログアウト成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully

  /api/auth/me:
    get:
      summary: 現在のユーザー情報取得
      tags: [認証]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: ユーザー情報
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /api/facilities:
    get:
      summary: 施設一覧取得
      tags: [施設]
      security:
        - bearerAuth: []
      parameters:
        - name: search
          in: query
          schema:
            type: string
          description: 検索キーワード
      responses:
        "200":
          description: 施設一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Facility"

    post:
      summary: 施設作成
      tags: [施設]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                address:
                  type: string
                phone:
                  type: string
                bed_capacity:
                  type: integer
                acceptance_conditions:
                  type: string
      responses:
        "201":
          description: 施設作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Facility"

  /api/facilities/{id}:
    get:
      summary: 施設詳細取得
      tags: [施設]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 施設詳細
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Facility"

    put:
      summary: 施設情報更新
      tags: [施設]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                address:
                  type: string
                phone:
                  type: string
                bed_capacity:
                  type: integer
                acceptance_conditions:
                  type: string
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Facility"

  /api/facilities/me:
    get:
      summary: 自分の施設情報取得
      tags: [施設]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 施設情報
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Facility"

  /api/requests:
    get:
      summary: リクエスト一覧取得
      tags: [リクエスト]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: リクエスト一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PlacementRequest"

    post:
      summary: リクエスト作成
      tags: [リクエスト]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - facility_id
                - patient_age
                - patient_gender
                - medical_condition
              properties:
                facility_id:
                  type: integer
                patient_age:
                  type: integer
                patient_gender:
                  type: string
                  enum: [男性, 女性, その他]
                medical_condition:
                  type: string
      responses:
        "201":
          description: リクエスト作成成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlacementRequest"

  /api/requests/{id}:
    get:
      summary: リクエスト詳細取得
      tags: [リクエスト]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: リクエスト詳細
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlacementRequest"

    put:
      summary: リクエスト更新
      tags: [リクエスト]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                patient_age:
                  type: integer
                patient_gender:
                  type: string
                medical_condition:
                  type: string
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlacementRequest"

    delete:
      summary: リクエストキャンセル
      tags: [リクエスト]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: キャンセル成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/requests/{id}/accept:
    post:
      summary: リクエスト承認
      tags: [リクエスト]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 承認成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  room_id:
                    type: string
                    format: uuid

  /api/requests/{id}/reject:
    post:
      summary: リクエスト拒否
      tags: [リクエスト]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 拒否成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/rooms:
    get:
      summary: メッセージルーム一覧取得
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: ルーム一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MessageRoom"

  /api/rooms/{id}:
    get:
      summary: メッセージルーム詳細取得
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: ルーム詳細
          content:
            application/json:
              schema:
                type: object
                properties:
                  room:
                    $ref: "#/components/schemas/MessageRoom"
                  messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/Message"
                  files:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoomFile"

  /api/rooms/{id}/messages:
    post:
      summary: メッセージ送信
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message_text
              properties:
                message_text:
                  type: string
      responses:
        "201":
          description: メッセージ送信成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"

  /api/rooms/{id}/files:
    post:
      summary: ファイルアップロード
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: アップロード成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoomFile"

  /api/rooms/{id}/files/{fileId}:
    get:
      summary: ファイルダウンロード
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: fileId
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: ファイル
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

    delete:
      summary: ファイル削除
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: fileId
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/rooms/{id}/accept:
    post:
      summary: 受け入れ承認
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: 承認成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/rooms/{id}/reject:
    post:
      summary: 受け入れ拒否
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: 拒否成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/rooms/{id}/complete:
    post:
      summary: 作業完了マーク
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: 完了マーク成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/rooms/{id}/cancel-completion:
    post:
      summary: 完了キャンセル
      tags: [メッセージルーム]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: キャンセル成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/documents:
    get:
      summary: 書類一覧取得
      tags: [書類]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 書類一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Document"

    post:
      summary: 書類アップロード
      tags: [書類]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - title
                - recipient_id
              properties:
                file:
                  type: string
                  format: binary
                title:
                  type: string
                document_type:
                  type: string
                folder:
                  type: string
                recipient_id:
                  type: integer
      responses:
        "201":
          description: アップロード成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"

  /api/documents/{id}:
    get:
      summary: 書類詳細取得
      tags: [書類]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 書類詳細
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"

    delete:
      summary: 書類削除
      tags: [書類]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/documents/{id}/download:
    get:
      summary: 書類ダウンロード
      tags: [書類]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: ファイル
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /api/admin/hospitals:
    get:
      summary: 病院一覧取得（管理者）
      tags: [病院]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 病院一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Hospital"

    post:
      summary: 病院作成（管理者）
      tags: [病院]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                name:
                  type: string
                address:
                  type: string
                phone:
                  type: string
      responses:
        "201":
          description: 病院作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  hospital:
                    $ref: "#/components/schemas/Hospital"

  /api/admin/hospitals/{id}:
    put:
      summary: 病院情報更新（管理者）
      tags: [病院]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                address:
                  type: string
                phone:
                  type: string
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Hospital"

    delete:
      summary: 病院削除（管理者）
      tags: [病院]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/admin/facilities:
    get:
      summary: 施設一覧取得（管理者）
      tags: [施設]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 施設一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Facility"

    post:
      summary: 施設作成（管理者）
      tags: [施設]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                name:
                  type: string
                address:
                  type: string
                phone:
                  type: string
                bed_capacity:
                  type: integer
                acceptance_conditions:
                  type: string
      responses:
        "201":
          description: 施設作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  facility:
                    $ref: "#/components/schemas/Facility"

  /api/admin/facilities/{id}:
    put:
      summary: 施設情報更新（管理者）
      tags: [施設]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                address:
                  type: string
                phone:
                  type: string
                bed_capacity:
                  type: integer
                acceptance_conditions:
                  type: string
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Facility"

    delete:
      summary: 施設削除（管理者）
      tags: [施設]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
